# Project Context (AI Assistant Memory)

This file helps AI assistants (Claude, Copilot, Cursor) understand your project's architecture, conventions, and patterns. Read this when:
- Starting work on the project
- Switching to a new IDE
- Working with an AI coding assistant

---

## Project Overview

**StoryForge** is an AI-powered book writing system for memoir and transformation authors.

**Philosophy**: Authors don't have a writing problem‚Äîthey have an extraction and organization problem. StoryForge surfaces, organizes, and synthesizes their knowledge into book chapters.

---

## Tech Stack

| Layer | Technology |
|-------|-----------|
| Frontend | React 19 + TypeScript + Tailwind CSS |
| Framework | Next.js 14 (App Router) |
| Database | Supabase (PostgreSQL + pgvector) |
| Auth | Supabase Auth (JWT) |
| LLM | Claude API (Anthropic) |
| Transcription | Whisper API (OpenAI) |
| Embeddings | OpenAI Embeddings (semantic search) |
| File Storage | Supabase Storage |
| Linting | ESLint 9 with custom rules |

---

## Architecture at a Glance

### Four Core Subsystems

1. **Interview Engine**: Voice ‚Üí Transcription ‚Üí Content extraction
2. **Source Brain**: Upload research ‚Üí AI processing ‚Üí RAG chat
3. **Voice Guardian**: Capture author voice ‚Üí Apply to all outputs
4. **Chapter Forge**: Gather content ‚Üí Generate polished drafts

---

## Code Conventions

### File Naming

| Type | Pattern | Example |
|------|---------|---------|
| Components | `PascalCase.tsx` | `AudioRecorder.tsx`, `ChapterEditor.tsx` |
| Pages | Directory structure | `app/(dashboard)/projects/[id]/page.tsx` |
| Utilities | `kebab-case.ts` | `format-date.ts`, `validate-input.ts` |
| API Routes | `route.ts` in directory | `app/api/projects/route.ts` |
| Types | File in `types/` | `types/database.ts`, `types/api.ts` |
| Services | `kebab-case.ts` | `services/transcription.ts` |

### Code Style

**Variables & Functions**
```typescript
const userName = 'Alice'  // camelCase
function getUserData() {} // camelCase
let count = 0            // camelCase
```

**Types & Interfaces**
```typescript
interface UserProfile {}    // PascalCase
type Status = 'active' | 'inactive' // PascalCase
enum UserRole {}           // PascalCase
```

**Boolean Variables**
```typescript
const isLoading = true       // Prefix: is
const hasError = false       // Prefix: has
const shouldRetry = true     // Prefix: should
const canDelete = false      // Prefix: can
```

**Constants**
```typescript
const MAX_RETRIES = 3        // UPPER_CASE for important constants
const DEFAULT_TIMEOUT = 5000 // or camelCase if not critical
```

### Import Alias

Always use `@/` for imports:

```typescript
// ‚úÖ GOOD
import { UserProfile } from '@/types/database'
import { getUserData } from '@/services/user'
import { Button } from '@/components/ui/button'

// ‚ùå AVOID
import { UserProfile } from '../../../../types/database'
```

The alias is configured in `tsconfig.json`:
```json
"paths": { "@/*": ["./src/*"] }
```

---

## ESLint Rules (Bug Prevention)

This project has ~30 carefully chosen rules. **Most Important:**

### üö® Critical Rules (Errors - Must Fix)

**Promise Handling** (Top priority!)
- ‚úÖ `no-floating-promises` - All promises must be `.catch()` or `await`
- ‚úÖ `no-misused-promises` - Don't use async in event handlers (use wrapper)
- ‚úÖ `await-thenable` - Only `await` actual promises

**Type Safety**
- ‚úÖ `no-unsafe-assignment` - Don't assign from `any` types
- ‚úÖ `no-unsafe-call` - Don't call `any` types as functions
- ‚úÖ `no-var` - Use `const`/`let`, never `var`

**Equality**
- ‚úÖ `eqeqeq` - Use `===` instead of `==` (prevents type coercion bugs)

**Security**
- ‚úÖ `no-eval` - Never use `eval()`
- ‚úÖ `no-implied-eval` - No strings to `setTimeout`

### ‚ö†Ô∏è Quality Rules (Warnings - Educatinal)

**Type Safety**
- `no-explicit-any` - Avoid `any` type (use `unknown` + type guard)
- `no-unsafe-return` - Don't return `any` from typed function

**Code Quality**
- `complexity` - Functions too complex (>15 branches)
- `max-depth` - Nested code too deep (>4 levels)
- `max-lines-per-function` - Functions too long (>100 lines)
- `no-console` - Remove debug logs before production
- `prefer-const` - Use `const` when variable isn't reassigned

**React**
- `react-hooks/exhaustive-deps` - useEffect dependencies must be complete
- `react/jsx-no-bind` - Don't create functions in JSX (performance)
- `react/no-array-index-key` - Don't use array index as key

---

## Project Structure

```
src/
‚îú‚îÄ‚îÄ app/                          # Next.js App Router
‚îÇ   ‚îú‚îÄ‚îÄ (auth)/                   # Auth group
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ login/page.tsx        # Login page (TBD)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ signup/page.tsx       # Signup page (TBD)
‚îÇ   ‚îú‚îÄ‚îÄ (dashboard)/              # Protected routes (TBD)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ projects/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ page.tsx          # Projects list
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ [id]/             # Single project
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ page.tsx      # Project dashboard
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ questions/    # Question bank (TBD)
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ record/       # Recording studio (TBD)
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ sources/      # Source library (TBD)
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ chat/         # RAG chat (TBD)
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ chapters/     # Chapter editor (TBD)
‚îÇ   ‚îú‚îÄ‚îÄ api/                      # API routes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ projects/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ recordings/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sources/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chapters/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ chat/
‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx                # Root layout
‚îÇ   ‚îú‚îÄ‚îÄ page.tsx                  # Home page
‚îÇ   ‚îî‚îÄ‚îÄ globals.css               # Global styles
‚îÇ
‚îú‚îÄ‚îÄ components/                   # React components
‚îÇ   ‚îú‚îÄ‚îÄ ui/                       # shadcn/ui components
‚îÇ   ‚îú‚îÄ‚îÄ AudioRecorder.tsx         # Voice recording
‚îÇ   ‚îú‚îÄ‚îÄ QuestionList.tsx          # Questions display
‚îÇ   ‚îú‚îÄ‚îÄ SourceUploader.tsx        # File upload
‚îÇ   ‚îú‚îÄ‚îÄ SourceChat.tsx            # RAG interface
‚îÇ   ‚îî‚îÄ‚îÄ ChapterEditor.tsx         # Draft editor
‚îÇ
‚îú‚îÄ‚îÄ lib/                          # Utilities
‚îÇ   ‚îú‚îÄ‚îÄ supabase/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ client.ts             # Browser Supabase client
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ server.ts             # Server Supabase client
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ middleware.ts         # Auth middleware
‚îÇ   ‚îú‚îÄ‚îÄ ai/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ claude.ts             # Claude API wrapper
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ whisper.ts            # Whisper transcription
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ embeddings.ts         # OpenAI embeddings
‚îÇ   ‚îî‚îÄ‚îÄ utils.ts                  # Helper functions
‚îÇ
‚îú‚îÄ‚îÄ services/                     # Business logic
‚îÇ   ‚îú‚îÄ‚îÄ transcription.ts          # Recording ‚Üí transcription pipeline
‚îÇ   ‚îú‚îÄ‚îÄ source-processing.ts      # Upload ‚Üí chunking ‚Üí embedding
‚îÇ   ‚îú‚îÄ‚îÄ question-generation.ts    # AI question synthesis
‚îÇ   ‚îî‚îÄ‚îÄ chapter-writing.ts        # Content ‚Üí draft generation
‚îÇ
‚îú‚îÄ‚îÄ types/                        # TypeScript definitions
‚îÇ   ‚îî‚îÄ‚îÄ database.ts               # DB types (auto-generated)
‚îÇ
‚îî‚îÄ‚îÄ styles/                       # Global styles
    ‚îî‚îÄ‚îÄ globals.css               # Tailwind + custom CSS
```

---

## Common Patterns

### API Route Template

```typescript
// src/app/api/projects/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'

export async function GET(request: NextRequest) {
  const supabase = await createClient()

  const { data, error } = await supabase
    .from('projects')
    .select('id, title, created_at')  // Specific columns, not *

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 400 })
  }

  return NextResponse.json({ projects: data })
}
```

**Key Points:**
- Import from `@/lib/supabase/server` (not client)
- Select specific columns (avoid `SELECT *`)
- Handle errors explicitly
- Return `NextResponse.json()`

### Component Template

```typescript
// src/components/Button.tsx
'use client'  // Only if using browser APIs

import { ReactNode } from 'react'

interface ButtonProps {
  children: ReactNode
  onClick: () => void
  disabled?: boolean
  variant?: 'primary' | 'secondary'
}

export function Button({
  children,
  onClick,
  disabled = false,
  variant = 'primary'
}: ButtonProps) {
  return (
    <button
      onClick={onClick}
      disabled={disabled}
      className={`px-4 py-2 ${variant === 'primary' ? 'bg-blue-500' : 'bg-gray-500'}`}
    >
      {children}
    </button>
  )
}
```

**Key Points:**
- Use TypeScript for props
- Use `interface` for component props
- Use `@/` import alias
- Avoid default exports
- Add 'use client' only when needed

### Service Function Template

```typescript
// src/services/transcription.ts
import Anthropic from '@anthropic-ai/sdk'

const anthropic = new Anthropic({
  apiKey: process.env.ANTHROPIC_API_KEY
})

export async function transcribeAudio(audioText: string): Promise<string> {
  try {
    const response = await anthropic.messages.create({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 2000,
      messages: [
        {
          role: 'user',
          content: `Analyze this transcript: ${audioText}`
        }
      ]
    })

    return response.content[0].type === 'text' ? response.content[0].text : ''
  } catch (error) {
    console.error('Transcription failed:', error)
    throw error
  }
}
```

---

## Database Access

### Selecting Data
```typescript
// ‚úÖ GOOD - Select specific columns
const { data } = await supabase
  .from('users')
  .select('id, name, email')
  .eq('id', userId)

// ‚ùå AVOID - Selecting everything
const { data } = await supabase
  .from('users')
  .select('*')
```

### Error Handling
```typescript
const { data, error } = await supabase.from('users').select()

if (error) {
  console.error('Database error:', error.message)
  throw new Error(`Failed to fetch users: ${error.message}`)
}

return data
```

### Types
```typescript
// Use types from src/types/database.ts
import type { User, Project } from '@/types/database'

const user: User = { id: '1', name: 'Alice', ... }
```

---

## AI API Patterns

### Claude API
```typescript
const anthropic = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY })

const response = await anthropic.messages.create({
  model: 'claude-sonnet-4-20250514',  // Use latest Sonnet
  max_tokens: 2000,
  messages: [
    { role: 'user', content: 'Your prompt...' }
  ]
})

const text = response.content[0].type === 'text' ? response.content[0].text : ''
```

### OpenAI Whisper (Transcription)
```typescript
const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY })

const transcript = await openai.audio.transcriptions.create({
  file: audioFile,
  model: 'whisper-1'
})
```

### OpenAI Embeddings (Semantic Search)
```typescript
const embedding = await openai.embeddings.create({
  model: 'text-embedding-3-small',
  input: 'Text to embed...'
})

// Store with pgvector in Supabase
await supabase.from('source_chunks').insert({
  content: text,
  embedding: embedding.data[0].embedding
})
```

---

## Commands to Remember

```bash
# Development
npm run dev              # Start dev server
npm run build            # Build for production
npm run lint             # Check code
npm run lint -- --fix    # Auto-fix code

# Database
npx supabase start       # Start local Supabase
npx supabase stop        # Stop Supabase
npx supabase db reset    # Reset to migrations

# Common workflow
npm run lint -- --fix    # Auto-fix linting
npm run build            # Check TypeScript
git add . && git commit  # Commit changes
```

---

## Known Issues & Gotchas

- **Promise rejections**: Always handle promises with `try/catch` or `.catch()`
- **useEffect deps**: Include all variables from the outer scope in dependencies array
- **Type coercion**: Use `===` instead of `==` to prevent unexpected type coercion
- **Array keys**: Never use array index as React key (breaks on reorder)
- **Console logs**: Remove before committing to production

---

## Related Files

- **HANDOFF.md** - For IDE setup and quick reference
- **PROJECT_MEMORY.md** - For "remember this" instructions
- **CLAUDE.md** (parent) - Full architecture and API docs
- **eslint.config.mjs** - Linting rules config

---

**This file helps AI assistants understand your project. Update it as your conventions evolve!**
